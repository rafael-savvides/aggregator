---
title: "donelist EDA"
output: html_notebook
editor_options: 
  chunk_output_type: console
---


```{r}
library(aggregator)
library(tidyverse)
library(lubridate)

donelist = donelist %>% as_tibble()
```



```{r}
social = donelist %>% 
    select(date, Social) %>% 
    separate_rows(Social, sep="; ?") %>% 
    separate(Social, c("activity", "people"), sep = ": ?") %>% 
    separate_rows(people, sep=", ?") %>% 
    separate_rows(activity, sep=", ?") %>% 
    rename(person = people) %>% 
    filter(!activity == "", !is.na(person)) %>% 
  mutate(activity=as.factor(activity), 
         person=as.factor(person))
  
social  %>% 
  count(activity, person, sort=TRUE)
```

```{r}
donelist %>% 
  filter(Exercise != "") %>% 
  count(Exercise, sort=TRUE)
```

```{r fig.height=15}
library(ggrepel)

donelist %>% 
  select(date, Video) %>% 
  separate_rows(Video, sep="; ?") %>% 
  mutate(date = as.Date(date), 
         y = cumsum(ifelse(Video != "", 1, 0)), 
         y = ifelse(Video == "", NA, y)) %>% 
  ggplot() + theme_minimal() +
  geom_point(aes(x=date, y=y)) + 
  geom_text_repel(aes(x=date, y=y, label=Video)) + 
  scale_x_date(name="",
               date_breaks = "2 weeks", 
               date_labels = "%b %d", 
               limits = as.Date(c("2020-01-01", "2020-12-31"))) + 
  scale_y_continuous(name="", breaks = NULL, labels = NULL)
```

```{r}
social %>% 
  filter(!is.na(person)) %>% 
  mutate(month = month(date)) %>% 
  group_by(month) %>% 
  add_count(person) %>% 
  slice_max(n) %>% View
```

# Modeling

One hot encoding was more complicated than it should be. 

- `stats::model.matrix()` is a nice built-in function but it needs `contrasts` argument to remove reference factors (https://stackoverflow.com/questions/62116652/one-hot-encoding-using-model-matrix). Not sure if it worked as it should, seems like there are fewer categories?
- `caret::dummyVars()` is also an option but it loads the heavy caret library.

```{r}
social_wide_mat = model.matrix(date~0+activity + person, data=social,
                           contrasts=list(activity=contrasts(social$activity, contrasts=FALSE), 
                                          person=contrasts(social$person, contrasts=FALSE)))
social_wide = cbind(date=social$date, data.frame(social_wide_mat)) %>% 
  group_by(date) %>% 
  summarize_all(function(x) if (sum(x)>0) 1 else 0) %>% 
  ungroup() %>% 
  mutate(month = month(date))
```

Weird model: predict month (1-12) from activity and person with normal linear regression.

- does higher/lower coefficients mean that term appears later/earlier in the year?
  - kind of but not really (e.g. puzzle has negative but it was only in Dec)
  - the cyclic nature of `month` screws up the linear model. There are terms with -20.
  - the estimate is also affected by interactions between activity and person
- does a zero coefficient mean that the term appears over the whole year or in the average of month (i.e. july)?
  - or is it that the average of date with that activity is the middle of the month? e.g. cinema activity has month

```{r}
library(broom)
social_wide_lm = glm(month~0+., data=social_wide[,-1])
tidy(social_wide_lm) %>% 
  filter(!is.na(estimate)) %>% 
  mutate(term = gsub("^activity|person", "", term)) %>% 
  mutate(term = forcats::fct_reorder(term, estimate)) %>% 
  ggplot() + 
  geom_point(aes(x=estimate, y=term)) + 
  geom_errorbarh(aes(xmin=estimate-std.error, xmax=estimate+std.error, y=term)) + 
  geom_vline(aes(xintercept=0), lty=2)
```

Same as above but only for interactions (e.g. gema_tolom)

```{r}
social_wide_interactions_mat = model.matrix(date~0+activity*person, data=social)
social_wide_interactions_mat = social_wide_interactions_mat[,!apply(social_wide_interactions_mat, 2, function(x) all(x==0))] # remove non-existent interactions
social_wide_interactions_mat = social_wide_interactions_mat[,grepl(":", colnames(social_wide_interactions_mat))] # keep only interactions

social_wide_interactions = cbind(date=social$date, data.frame(social_wide_interactions_mat)) %>% 
  group_by(date) %>% 
  summarize_all(function(x) if (sum(x)>0) 1 else 0) %>% 
  ungroup() %>% 
  mutate(month = month(date))
```

```{r}
social_wide_interactions_lm = glm(month~0+., data=social_wide_interactions[,-1])
tidy(social_wide_interactions_lm) %>% 
  filter(!is.na(estimate)) %>% 
  mutate(term = gsub("^activity|^person", "", term)) %>% 
  mutate(term = gsub("\\.person", "_", term)) %>% 
  mutate(term = forcats::fct_reorder(term, estimate)) %>% 
  ggplot() + 
  geom_point(aes(x=estimate, y=term)) + 
  geom_errorbarh(aes(xmin=estimate-std.error, xmax=estimate+std.error, y=term)) + 
  geom_vline(aes(xintercept=0), lty=2)
```